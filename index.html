<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="ALTIN-S1 ve GRAM ALTIN fiyat oranƒ± analizi">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Altƒ±n Analiz">
  <title>Altƒ±n Fiyat Analizi</title>
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkFsdMSxbiBGaXlhdCBBbmFsaXppIiwKICAic2hvcnRfbmFtZSI6ICJBbHTEsW4iLAogICJkZXNjcmlwdGlvbiI6ICJBTFRJTi1TMSAvIEdSQU0gQUxUSU4gb3JhbsSxIGFuYWxpemkiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM2NjdlZWEiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyBmaWxsPSclMjM2NjdlZWEnLyUzRSUzQ3RleHQgeD0nNTAnIHk9JzU1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0UlRjAlOUYlOTIlQjAlM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyBmaWxsPSclMjM2NjdlZWEnLyUzRSUzQ3RleHQgeD0nNTAnIHk9JzU1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0UlRjAlOUYlOTIlQjAlM0MvdGV4dCUzRSUzQy9zdmclM0UiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 15px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      color: #667eea;
      text-align: center;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      margin-bottom: 15px;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
    }

    @media (min-width: 640px) {
      .controls {
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 12px 16px;
      border-radius: 12px;
      flex: 1;
      max-width: 300px;
      margin: 0 auto;
    }

    @media (min-width: 640px) {
      .control-group {
        margin: 0;
      }
    }

    label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    select {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 0.95rem;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      outline: none;
    }

    select:hover {
      border-color: #667eea;
    }

    select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .chart-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .chart-wrapper {
      position: relative;
      height: 350px;
      width: 100%;
    }

    @media (min-width: 768px) {
      .chart-wrapper {
        height: 450px;
      }
    }

    canvas {
      max-width: 100%;
      height: auto !important;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 1.1rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(102, 126, 234, 0.3);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      color: white;
    }

    .stat-label {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .error-message {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 15px;
      border-radius: 12px;
      margin-top: 20px;
      text-align: center;
    }

    .data-info {
      text-align: center;
      color: #888;
      font-size: 0.85rem;
      margin-top: 10px;
    }

    .install-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .install-banner.show {
      display: flex;
    }

    .install-text {
      flex: 1;
      font-size: 0.9rem;
    }

    .install-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      white-space: nowrap;
    }

    .install-btn:hover {
      transform: scale(1.05);
    }

    .install-btn:active {
      transform: scale(0.95);
    }

    .offline-indicator {
      background: #ff6b6b;
      color: white;
      padding: 8px;
      text-align: center;
      font-size: 0.85rem;
      display: none;
    }

    .offline-indicator.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="offline-indicator" id="offlineIndicator">
    üìµ ƒ∞nternet baƒülantƒ±sƒ± yok - √ñnbelleƒüe alƒ±nan veriler g√∂steriliyor
  </div>

  <div class="container">
    <div class="install-banner" id="installBanner">
      <div class="install-text">üì± Bu uygulamayƒ± ana ekranƒ±nƒ±za ekleyin</div>
      <button class="install-btn" id="installBtn">Y√ºkle</button>
    </div>

    <div class="header">
      <h1>üìä Altƒ±n Fiyat Analizi</h1>
      <div class="subtitle">ALTIN-S1 / GRAM ALTIN Oranƒ±</div>
      
      <div class="controls">
        <div class="control-group">
          <label for="monthSelect">‚è±Ô∏è Zaman Aralƒ±ƒüƒ±:</label>
          <select id="monthSelect">
            <option value="1" selected>1 Ay</option>
            <option value="3">3 Ay</option>
            <option value="6">6 Ay</option>
            <option value="12">12 Ay</option>
          </select>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div id="loadingIndicator" class="loading">
        <div class="loading-spinner"></div>
        <div>Veriler y√ºkleniyor...</div>
      </div>
      <div class="chart-wrapper" style="display: none;">
        <canvas id="priceChart"></canvas>
      </div>
      <div id="errorMessage" class="error-message" style="display: none;"></div>
      <div id="statsGrid" class="stats-grid" style="display: none;"></div>
      <div id="dataInfo" class="data-info" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Service Worker Kayƒ±t
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const swCode = `
          const CACHE_NAME = 'altin-analiz-v1';
          const urlsToCache = [
            'https://cdn.jsdelivr.net/npm/chart.js'
          ];

          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => cache.addAll(urlsToCache))
            );
          });

          self.addEventListener('fetch', event => {
            event.respondWith(
              caches.match(event.request)
                .then(response => {
                  if (response) {
                    return response;
                  }
                  return fetch(event.request).then(response => {
                    if (!response || response.status !== 200 || response.type !== 'basic') {
                      return response;
                    }
                    const responseToCache = response.clone();
                    caches.open(CACHE_NAME)
                      .then(cache => {
                        cache.put(event.request, responseToCache);
                      });
                    return response;
                  });
                })
            );
          });

          self.addEventListener('activate', event => {
            event.waitUntil(
              caches.keys().then(cacheNames => {
                return Promise.all(
                  cacheNames.map(cacheName => {
                    if (cacheName !== CACHE_NAME) {
                      return caches.delete(cacheName);
                    }
                  })
                );
              })
            );
          });
        `;

        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);

        navigator.serviceWorker.register(swUrl)
          .then(reg => console.log('Service Worker kayƒ±tlƒ±'))
          .catch(err => console.log('Service Worker hatasƒ±:', err));
      });
    }

    // PWA Y√ºkleme Prompt
    let deferredPrompt;
    const installBanner = document.getElementById('installBanner');
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBanner.classList.add('show');
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        installBanner.classList.remove('show');
      }
      
      deferredPrompt = null;
    });

    window.addEventListener('appinstalled', () => {
      installBanner.classList.remove('show');
      deferredPrompt = null;
    });

    // √áevrimdƒ±≈üƒ± G√∂stergesi
    const offlineIndicator = document.getElementById('offlineIndicator');

    window.addEventListener('online', () => {
      offlineIndicator.classList.remove('show');
    });

    window.addEventListener('offline', () => {
      offlineIndicator.classList.add('show');
    });

    // Altƒ±n Fiyat Analizi Kodu
    const baseUrl = "https://api.investing.com/api/financialdata/historical";
    const altins1 = "1197643";
    const gramaltin = "50655";

    const verticalLinePlugin = {
      id: 'verticalLinePlugin',
      afterDraw: (chart) => {
        if (chart.tooltip._active && chart.tooltip._active.length) {
          const ctx = chart.ctx;
          const x = chart.tooltip._active[0].element.x;
          const topY = chart.scales.y.top;
          const bottomY = chart.scales.y.bottom;

          ctx.save();
          ctx.beginPath();
          ctx.moveTo(x, topY);
          ctx.lineTo(x, bottomY);
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.strokeStyle = 'rgba(102, 126, 234, 0.5)';
          ctx.stroke();
          ctx.restore();
        }
      }
    };

    function parsePrice(priceStr) {
      if (!priceStr) return null;
      try {
        return Number(priceStr.toString().replaceAll(".", "").replaceAll(",", "."));
      } catch {
        return null;
      }
    }

    async function getFin(code, stDate, endDate) {
      try {
        const response = await fetch(`${baseUrl}/${code}?start-date=${stDate}&end-date=${endDate}&time-frame=Daily&add-missing-rows=false`, {
          headers: {
            "domain-id": "tr"
          }
        });
        
        if (!response.ok) {
          throw new Error(`API hatasƒ±: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data || !data.data || !Array.isArray(data.data)) {
          throw new Error('Ge√ßersiz veri formatƒ±');
        }
        
        return data;
      } catch (error) {
        console.error("Veri alƒ±namadƒ±:", error);
        throw error;
      }
    }

    let chart;

    async function drawChart(month) {
      const loadingEl = document.getElementById('loadingIndicator');
      const chartWrapper = document.querySelector('.chart-wrapper');
      const errorEl = document.getElementById('errorMessage');
      const statsGrid = document.getElementById('statsGrid');
      const dataInfo = document.getElementById('dataInfo');

      loadingEl.style.display = 'block';
      chartWrapper.style.display = 'none';
      errorEl.style.display = 'none';
      statsGrid.style.display = 'none';
      dataInfo.style.display = 'none';

      try {
        const st = new Date();
        const end = new Date();
        st.setMonth(st.getMonth() - month);

        const stStr = st.toISOString().split("T")[0];
        const endStr = end.toISOString().split("T")[0];

        const [altins1prices, gramaltinprices] = await Promise.all([
          getFin(altins1, stStr, endStr),
          getFin(gramaltin, stStr, endStr)
        ]);

        const gramAltinMap = new Map();
        gramaltinprices.data.forEach(item => {
          if (item.rowDate && item.last_close) {
            gramAltinMap.set(item.rowDate, item.last_close);
          }
        });

        const dataPoints = [];
        
        altins1prices.data.forEach(element => {
          const date = element.rowDate;
          const gramPrice = gramAltinMap.get(date);
          
          if (!date || !element.last_close || !gramPrice) {
            return;
          }
          
          const ha = parsePrice(element.last_close);
          const ga = parsePrice(gramPrice);
          
          if (ha === null || ga === null || ga === 0) {
            return;
          }
          
          const ratio = (ha * 100) / ga;
          
          dataPoints.push({
            date: date,
            ratio: ratio,
            altinValue: (ha * 100).toFixed(2),
            gramAltinValue: ga.toFixed(2)
          });
        });

        if (dataPoints.length === 0) {
          throw new Error('E≈üle≈üen veri bulunamadƒ±');
        }

        const parse = d => {
          const [day, month, year] = d.split(".");
          return new Date(year, month - 1, day);
        };

        dataPoints.sort((a, b) => parse(a.date) - parse(b.date));


        const labels = dataPoints.map(d => d.date);
        const data = dataPoints.map(d => d.ratio);
        const altinValues = dataPoints.map(d => d.altinValue);
        const gramAltinValues = dataPoints.map(d => d.gramAltinValue);

        const currentRatio = data[0].toFixed(2);
        const avgRatio = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2);
        const maxRatio = Math.max(...data).toFixed(2);
        const minRatio = Math.min(...data).toFixed(2);

        statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">G√ºncel Oran</div>
            <div class="stat-value">${currentRatio}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ortalama</div>
            <div class="stat-value">${avgRatio}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">En Y√ºksek</div>
            <div class="stat-value">${maxRatio}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">En D√º≈ü√ºk</div>
            <div class="stat-value">${minRatio}</div>
          </div>
        `;

        dataInfo.textContent = `${dataPoints.length} g√ºn verisi g√∂steriliyor`;

        const ctx = document.getElementById("priceChart").getContext("2d");
        if (chart) chart.destroy();

        const isMobile = window.innerWidth < 640;

        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Fiyat Oranƒ±",
              data: data,
              borderColor: "#667eea",
              backgroundColor: "rgba(102, 126, 234, 0.1)",
              borderWidth: 3,
              pointRadius: isMobile ? 0 : 2,
              pointHoverRadius: 6,
              pointBackgroundColor: "#667eea",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: isMobile ? 1.2 : 2,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                titleColor: '#333',
                bodyColor: '#666',
                borderColor: '#667eea',
                borderWidth: 2,
                padding: 12,
                displayColors: false,
                callbacks: {
                  title: function(context) {
                    return context[0].label;
                  },
                  label: function(context) {
                    const index = context.dataIndex;
                    const fark = context.parsed.y.toFixed(2);
                    const altin = altinValues[index];
                    const gramAltin = gramAltinValues[index];
                    return [
                      `Oran: ${fark}`,
                      `ALTIN-S1: ${altin}`,
                      `GRAM ALTIN: ${gramAltin}`
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  autoSkip: true,
                  maxTicksLimit: isMobile ? 6 : 12,
                  maxRotation: 45,
                  minRotation: 45,
                  font: {
                    size: isMobile ? 10 : 11
                  }
                },
                grid: {
                  display: false
                }
              },
              y: {
                ticks: {
                  font: {
                    size: isMobile ? 10 : 11
                  },
                  callback: function(value) {
                    return value.toFixed(2);
                  }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              }
            }
          },
          plugins: [verticalLinePlugin]
        });

        loadingEl.style.display = 'none';
        chartWrapper.style.display = 'block';
        statsGrid.style.display = 'grid';
        dataInfo.style.display = 'block';

      } catch (error) {
        console.error('Grafik hatasƒ±:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `‚ö†Ô∏è ${error.message || 'Veriler y√ºklenirken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyin.'}`;
      }
    }

    document.getElementById("monthSelect").addEventListener("change", function () {
      const months = parseInt(this.value);
      drawChart(months);
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (chart) {
          const months = parseInt(document.getElementById("monthSelect").value);
          drawChart(months);
        }
      }, 250);
    });

    drawChart(1);
  </script>
</body>
</html>
